<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FENATS · Admin · Crear usuario</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --shadow:0 20px 60px rgba(0,0,0,.35);

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --blue:#3b82f6;

      --btn: rgba(255,255,255,.10);
      --btnBorder: rgba(255,255,255,.16);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(800px 500px at 20% 10%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(700px 500px at 40% 90%, rgba(245,158,11,.16), transparent 60%),
        var(--bg);
      padding: 24px;

      /* ✅ para footer abajo */
      display:flex;
      flex-direction:column;
    }

    /* ✅ centra el contenido pero deja footer al fondo */
    .page{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .wrap{width:min(640px,100%)}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: var(--blue);
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--btnBorder);
      background: var(--btn);
      color: var(--text);
      text-decoration:none;
      font-weight: 900;
      cursor:pointer;
      font-size: 14px;
    }
    .btnPrimary{
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.14);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding: 20px 22px 14px;
      border-bottom: 1px solid var(--border);
    }
    h1{margin:0;font-size:20px}
    p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .body{padding: 18px 22px 20px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 620px){
      .grid{grid-template-columns: 1fr;}
    }
    .label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 2px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .input{
      width:100%;
      border-radius:14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 12px 12px;
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .input::placeholder{color: rgba(255,255,255,.55)}

    select.input{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;

      background-color: rgba(255,255,255,.06);
      color: var(--text);
      color-scheme: dark;

      padding-right: 40px;
      cursor: pointer;
    }
    select.input option{
      background: var(--bg);
      color: var(--text);
    }
    .selectWrap{ position:relative; }
    .selectWrap::after{
      content:"▾";
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      color: rgba(255,255,255,.70);
      pointer-events:none;
      font-size: 14px;
    }

    .actions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .actions .btn{
      flex: 1;
      min-width: 160px;
      padding: 12px 14px;
      font-size: 14px;
    }
    .alert{
      margin-top:12px;
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .okbox{
      margin-top:12px;
      border: 1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      padding: 10px 12px;
      border-radius: 14px;
      color: rgba(255,255,255,.92);
      font-size: 13px;
    }
    .hint{
      margin-top:12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    /* ✅ Password checklist */
    .checks{
      margin-top:10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .checksTitle{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 8px;
    }
    .check{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 13px;
      color: rgba(255,255,255,.75);
      margin: 6px 0;
    }
    .icon{
      width:18px;height:18px;border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      display:inline-flex;align-items:center;justify-content:center;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.60);
      background: rgba(255,255,255,.06);
      flex: 0 0 18px;
    }
    .check.ok{ color: rgba(255,255,255,.92); }
    .check.ok .icon{
      border-color: rgba(34,197,94,.40);
      background: rgba(34,197,94,.14);
      color: rgba(34,197,94,1);
    }

    /* helper para username */
    .small{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:12px;font-weight:900;
      margin-top:10px;
    }
    .pDot{width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.45)}
  </style>
</head>
<body>

  <div class="page">
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <span class="dot"></span>
          <span>FENATS · Usuarios</span>
        </div>

        <div class="nav">
          <a class="btn" href="/admin">Panel</a>
          <a class="btn" href="/admin/members">Socios</a>
          <a class="btn" href="/admin/logout">Salir</a>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <h1>Crear usuario administrador</h1>
          <p>Solo SUPERADMIN puede crear usuarios. Las contraseñas se guardan encriptadas.</p>
        </div>

        <div class="body">
          <form id="form" method="post" action="/admin/users/new" novalidate>
            <div class="grid">
              <div>
                <label class="label" for="username">Usuario (RUT sin DV)</label>
                <input
                  id="username"
                  class="input"
                  type="text"
                  name="username"
                  inputmode="numeric"
                  autocomplete="off"
                  placeholder="Ej: 12345678"
                  value="<%= values?.username ?? '' %>"
                  required
                  minlength="8"
                  maxlength="8"
                  pattern="^\\d{8}$"
                />
                <div class="small">Debe ser exactamente <b>8 dígitos</b> (solo números). Ej: si tu RUT es 12.345.678-9, aquí va: <b>12345678</b>.</div>
                <div class="pill"><span class="pDot"></span><span id="userStatus">Esperando 8 dígitos...</span></div>
              </div>

              <div>
                <label class="label" for="email">Correo</label>
                <input
                  id="email"
                  class="input"
                  type="email"
                  name="email"
                  placeholder="ej: usuario@fenats.cl"
                  value="<%= values?.email ?? '' %>"
                  required
                />
              </div>

              <div>
                <label class="label" for="role">Rol</label>
                <div class="selectWrap">
                  <select id="role" class="input" name="role" required>
                    <% const currentRole = (values?.role ?? 'VIEWER').toUpperCase(); %>
                    <option value="VIEWER" <%= currentRole === 'VIEWER' ? 'selected' : '' %>>VIEWER (solo lectura)</option>
                    <option value="ADMIN"  <%= currentRole === 'ADMIN' ? 'selected' : '' %>>ADMIN (gestión completa)</option>
                    <option value="SUPERADMIN" <%= currentRole === 'SUPERADMIN' ? 'selected' : '' %>>SUPERADMIN (crea usuarios)</option>
                  </select>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="grid">
              <div>
                <label class="label" for="password">Contraseña</label>
                <input
                  id="password"
                  class="input"
                  type="password"
                  name="password"
                  placeholder="Mínimo 8 + mayúscula + número + símbolo"
                  required
                  minlength="8"
                  autocomplete="new-password"
                />

                <div class="checks" aria-live="polite">
                  <div class="checksTitle">Requisitos de contraseña</div>

                  <div id="cLen" class="check"><span class="icon">•</span><span>Mínimo 8 caracteres</span></div>
                  <div id="cUpper" class="check"><span class="icon">•</span><span>Al menos 1 letra mayúscula (A-Z)</span></div>
                  <div id="cNum" class="check"><span class="icon">•</span><span>Al menos 1 número (0-9)</span></div>
                  <div id="cSym" class="check"><span class="icon">•</span><span>Al menos 1 símbolo (ej: !@#$)</span></div>
                  <div id="cMatch" class="check"><span class="icon">•</span><span>Coincide con confirmación</span></div>
                </div>
              </div>

              <div>
                <label class="label" for="password2">Confirmar contraseña</label>
                <input
                  id="password2"
                  class="input"
                  type="password"
                  name="password2"
                  placeholder="Repite la contraseña"
                  required
                  minlength="8"
                  autocomplete="new-password"
                />
                <div class="small">Tip: usa una frase larga + símbolos. Ej: <b>Fenats@2026!</b> (mejor aún más larga).</div>
              </div>
            </div>

            <div class="actions">
              <button id="btnSubmit" class="btn btnPrimary" type="submit">Crear usuario</button>
              <a class="btn" href="/admin/users">Volver</a>
            </div>

            <% if (error) { %>
              <div class="alert"><b>Error:</b> <%= error %></div>
            <% } %>

            <% if (message) { %>
              <div class="okbox"><b>OK:</b> <%= message %></div>
            <% } %>
          </form>

          <div class="hint">
            Recomendación: en producción usa HTTPS, cookies seguras y 2FA (SMS/WhatsApp/Authenticator).
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("form");
    const username = document.getElementById("username");
    const userStatus = document.getElementById("userStatus");
    const password = document.getElementById("password");
    const password2 = document.getElementById("password2");
    const btnSubmit = document.getElementById("btnSubmit");

    const cLen = document.getElementById("cLen");
    const cUpper = document.getElementById("cUpper");
    const cNum = document.getElementById("cNum");
    const cSym = document.getElementById("cSym");
    const cMatch = document.getElementById("cMatch");

    function setOk(el, ok){
      el.classList.toggle("ok", !!ok);
      const icon = el.querySelector(".icon");
      icon.textContent = ok ? "✓" : "•";
    }

    function onlyDigits8(v){
      return (v || "").replace(/\\D/g, "").slice(0, 8);
    }

    function validateUsername(){
      const v = onlyDigits8(username.value);
      if (username.value !== v) username.value = v;

      const ok = /^\\d{8}$/.test(v);
      userStatus.textContent = ok ? "OK (8 dígitos)" : `Llevas ${v.length}/8 dígitos`;
      return ok;
    }

    function validatePassword(){
      const p = password.value || "";
      const p2 = password2.value || "";

      const okLen = p.length >= 8;
      const okUpper = /[A-Z]/.test(p);
      const okNum = /[0-9]/.test(p);
      const okSym = /[^A-Za-z0-9]/.test(p);
      const okMatch = p.length > 0 && p === p2;

      setOk(cLen, okLen);
      setOk(cUpper, okUpper);
      setOk(cNum, okNum);
      setOk(cSym, okSym);
      setOk(cMatch, okMatch);

      return okLen && okUpper && okNum && okSym && okMatch;
    }

    function refresh(){
      const uOk = validateUsername();
      const pOk = validatePassword();

      btnSubmit.disabled = !(uOk && pOk);
      btnSubmit.style.opacity = btnSubmit.disabled ? .65 : 1;
      btnSubmit.style.cursor = btnSubmit.disabled ? "not-allowed" : "pointer";
    }

    username.addEventListener("input", refresh);
    password.addEventListener("input", refresh);
    password2.addEventListener("input", refresh);

    refresh();

    form.addEventListener("submit", (e) => {
      const uOk = validateUsername();
      const pOk = validatePassword();
      if (!uOk || !pOk) {
        e.preventDefault();
        alert("Revisa el usuario (8 dígitos) y los requisitos de contraseña.");
      }
    });
  </script>

  <%- include("../partials/footer") %>
</body>
</html>



